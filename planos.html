<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Planos VIP</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Orbitron:wght@600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --red-main:#ff002b;
      --red-dark:#b0001c;
      --glass:rgba(15,15,15,.74);
      --glass-2:rgba(18,18,18,.58);
      --border:rgba(255,255,255,.10);
      --radius:14px;
      --radius-lg:18px;
      --transition:.28s ease;
      --shadow:0 18px 45px rgba(0,0,0,.45);
      --shadow-soft:0 10px 26px rgba(0,0,0,.32);
      --text-dim:rgba(255,255,255,.78);
      --max:1040px;
    }

    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Inter',sans-serif;
      background:url('https://i.imgur.com/eKjFtd1.png') center/cover fixed no-repeat;
      color:#fff;
      min-height:100vh;
    }
    body::before{
      content:"";
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.64);
      backdrop-filter:blur(18px);
      z-index:-1;
    }

    .wrap{width:min(var(--max),100%);margin:0 auto;padding:0 1rem}

    header{
      text-align:center;
      padding:3.1rem 1rem 1.3rem;
    }
    header h1{
      font-family:'Orbitron',sans-serif;
      font-size:clamp(2.3rem,5vw,4.4rem);
      letter-spacing:3px;
      background:linear-gradient(90deg,#ff002b,#ff4d4d);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }
    header p{margin-top:.5rem;color:var(--text-dim);font-weight:600}

    .box{
      background:linear-gradient(180deg,var(--glass),var(--glass-2));
      border:1px solid var(--border);
      border-radius:var(--radius-lg);
      box-shadow:var(--shadow);
      padding:1.3rem;
      margin-bottom:1.3rem;
    }

    .plans{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:1rem;
    }
    .plan{
      position:relative;
      background:linear-gradient(180deg,var(--glass),var(--glass-2));
      border:1px solid var(--border);
      border-radius:var(--radius-lg);
      padding:1.2rem;
      box-shadow:var(--shadow-soft);
      overflow:hidden;
    }
    .plan::before{
      content:"";
      position:absolute;
      inset:-80px -80px auto auto;
      width:190px;height:190px;
      background:radial-gradient(circle, rgba(255,0,43,.22), rgba(255,0,43,0));
    }
    .plan h2{
      font-family:'Orbitron',sans-serif;
      font-size:1.3rem;
      letter-spacing:1.5px;
      display:flex;
      justify-content:space-between;
      gap:.8rem;
    }
    .tag{
      font-size:.78rem;
      font-weight:900;
      padding:.35rem .6rem;
      border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      white-space:nowrap;
    }
    .price{
      margin:.8rem 0;
      display:flex;
      gap:.4rem;
      align-items:flex-end;
    }
    .price strong{font-size:2rem;color:#ff6b6b}
    .price span{color:var(--text-dim);font-weight:700}

    .benefits{
      list-style:none;
      display:grid;
      gap:.55rem;
      font-weight:650;
      color:var(--text-dim);
    }
    .benefits span{color:#fff;font-weight:750}

    .btn{
      margin-top:1rem;
      width:100%;
      background:linear-gradient(135deg,var(--red-main),var(--red-dark));
      color:#fff;
      padding:.95rem;
      border-radius:var(--radius);
      font-weight:800;
      text-decoration:none;
      display:inline-flex;
      justify-content:center;
      align-items:center;
      border:0;
      cursor:pointer;
      transition:.25s;
      user-select:none;
    }
    .btn:hover{filter:brightness(1.07)}
    .btn:disabled{opacity:.7;cursor:not-allowed}

    @media(max-width:900px){
      .plans{grid-template-columns:1fr}
    }

    /* ===== MODAL ===== */
    .modalWrap{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.62);
      backdrop-filter:blur(8px);
      z-index:9999;
      padding:1rem;
    }
    .modal{
      width:min(560px,100%);
      margin:10vh auto 0;
      background:linear-gradient(180deg,var(--glass),var(--glass-2));
      border:1px solid rgba(255,255,255,.14);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:1.15rem;
    }
    .modal h3{
      font-family:'Orbitron',sans-serif;
      letter-spacing:1px;
      margin-bottom:.35rem;
      font-size:1.25rem;
    }
    .modal p{color:var(--text-dim);font-weight:650;margin-bottom:.85rem}
    .codeBox{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      border-radius:14px;
      padding:.9rem;
      white-space:pre-line;
      color:#fff;
      font-weight:650;
      line-height:1.35rem;
    }
    .modalActions{
      display:flex;
      gap:.6rem;
      margin-top:1rem;
      flex-wrap:wrap;
    }
    .modalActions .btn{
      margin-top:0;
      flex:1;
      min-width:180px;
    }
    .btnGhost{
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
    }
  </style>
</head>

<body>
  <header class="wrap">
    <h1>PLANOS VIP</h1>
    <p>Escolha seu plano e libere o acesso premium</p>
  </header>


  
  <section class="box" id="postpay" style="display:none;margin-bottom:1rem;">
  <h2 style="font-family:'Orbitron',sans-serif;letter-spacing:1px;margin-bottom:.35rem;">
    ‚úÖ Pagamento recebido
  </h2>
  <p id="postpayText" style="color:var(--text-dim);font-weight:650;line-height:1.45;">
    Seu pagamento foi registrado. Aguarde no m√°ximo <b>5h</b> para ativa√ß√£o do VIP na sua conta.
  </p>
  <p style="margin-top:.65rem;color:rgba(255,255,255,.72);font-weight:650;">
    Se n√£o liberar dentro do prazo, abra um ticket no Discord com o c√≥digo gerado.
  </p>
</section>





  <main class="wrap box" id="app" style="display:none">
    <div class="plans">
      <!-- VIP COMUM -->
      <article class="plan">
        <h2>VIP COMUM <span class="tag">30 DIAS</span></h2>
        <div class="price">
          <strong>R$ 25,00</strong><span>/ √∫nico</span>
        </div>

        <ul class="benefits">
          <li>üì¢ <span>Marca√ß√£o @everyone no canal de divulga√ß√£o</span></li>
          <li>üåê <span>Acesso VIP ao site com todas as GMs</span></li>
          <li>‚è≥ <span>GMs liberadas 1‚Äì2 meses antes</span></li>
          <li>‚è≥ <span>GMs Superiores profissionais apenas pros vip</span></li>
          <li>üöÄ <span>Acesso antecipado com link direto</span></li>
          <li>üè∑Ô∏è <span>Tag exclusiva no Discord</span></li>
          <li>üõ†Ô∏è <span>Suporte priorizado</span></li>
        </ul>

        <button class="btn" type="button" onclick="comprar('vip_30d')">Comprar VIP</button>
      </article>

      <!-- GOLD -->
      <article class="plan">
        <h2>GOLD <span class="tag">PERMANENTE</span></h2>
        <div class="price">
          <strong>R$ 50,00</strong><span>/ √∫nico</span>
        </div>

        <ul class="benefits">
          <li>üëë <span>Tudo do VIP Comum</span></li>
          <li>‚ö° <span>Prioridade m√°xima</span></li>
          <li>üèÜ <span>Acesso permanente</span></li>
        </ul>

        <button class="btn" type="button" onclick="comprar('gold_perm')">Comprar Gold</button>
      </article>
    </div>
  </main>

  <!-- MODAL -->
  <div id="modalVip" class="modalWrap" onclick="fecharModal(event)">
    <div class="modal">
      <h3>‚úÖ Compra iniciada</h3>
      <p>Copie a mensagem e depois clique em ‚ÄúIr para pagamento‚Äù.</p>

      <div id="vipTexto" class="codeBox"></div>

      <div class="modalActions">
        <button class="btn btnGhost" type="button" onclick="copiarVip()">Copiar mensagem</button>
        <a id="vipPagar" class="btn" href="#">Ir para pagamento</a>
      </div>
    </div>
  </div>

<script>
  // evita spam no canal quando o usu√°rio recarrega a p√°gina
  function jaAvisou(discordPlanoKey) {
    return sessionStorage.getItem(discordPlanoKey) === "1";
  }
  function marcarAvisou(discordPlanoKey) {
    sessionStorage.setItem(discordPlanoKey, "1");
  }

  function getPlanoSelecionado() {
    return sessionStorage.getItem("sx_plano_selecionado") || "";
  }

  function setPlanoSelecionado(plano) {
    sessionStorage.setItem("sx_plano_selecionado", plano);
  }

  function setButtonsDisabled(disabled) {
    document.querySelectorAll(".plans .btn").forEach((b) => (b.disabled = disabled));
  }

  function fecharModal(e) {
    if (e.target && e.target.id === "modalVip") {
      document.getElementById("modalVip").style.display = "none";
    }
  }

  async function avisarPagamento(plano) {
    // key por plano pra n√£o spammar
    const key = `sx_aviso_${plano}`;
    if (jaAvisou(key)) return;

    const r = await fetch("/.netlify/functions/notify_vip_purchase", {
      method: "POST",
      credentials: "include",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ plano }),
    });

    if (!r.ok) {
      console.log("notify fail:", await r.text());
      return; // n√£o trava UX se falhar
    }

    marcarAvisou(key);
  }

  function mostrarPosPagamento() {
    const qs = new URLSearchParams(location.search);
    if (qs.get("pago") !== "1") return;

    const box = document.getElementById("postpay");
    const txt = document.getElementById("postpayText");
    if (!box || !txt) return;

    // tenta pegar do querystring, se n√£o tiver pega do sessionStorage
    const plano = qs.get("plano") || getPlanoSelecionado() || "vip_30d";

    // mensagem diferente por plano (mais confian√ßa pro usu√°rio)
    if (plano === "gold_perm") {
      txt.innerHTML = `Seu pagamento foi registrado. Aguarde no m√°ximo <b>5h</b> para ativa√ß√£o do <b>GOLD</b> na sua conta.`;
    } else {
      txt.innerHTML = `Seu pagamento foi registrado. Aguarde no m√°ximo <b>5h</b> para ativa√ß√£o do <b>VIP</b> na sua conta.`;
    }

    box.style.display = "block";
    window.scrollTo({ top: 0, behavior: "smooth" });

    // avisa no discord (1x)
    avisarPagamento(plano);
  }

  async function ensureLogin() {
    const r = await fetch("/.netlify/functions/planos_me", { credentials: "include" });
    if (!r.ok) {
      location.href = "/.netlify/functions/discordlogin_planos?return=/planos.html";
      return;
    }
    document.getElementById("app").style.display = "block";
    mostrarPosPagamento();
  }

  async function comprar(plano) {
    try {
      setButtonsDisabled(true);
      setPlanoSelecionado(plano);

      const r = await fetch("/.netlify/functions/gerar_codigo_vip", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ plano })
      });

      if (!r.ok) {
        setButtonsDisabled(false);
        alert("Erro ao iniciar compra. Tente novamente.");
        return;
      }

      const data = await r.json();

      // CHECKOUTS
      const checkoutUrl =
        plano === "vip_30d"
          ? "https://checkout.infinitepay.io/siqueira-santos-12/7BzqiAdKnD"
          : "https://checkout.infinitepay.io/maria-luiza-b19/7BshJTY0D3";

      const texto =
`Depois de pagar, abra um ticket no Discord e envie:

ol√°, acabei de adquirir vip (${data.plano_nome}) pelo valor de R$ ${data.valor_reais}
c√≥digo: ${data.codigo}`;

      document.getElementById("vipTexto").textContent = texto;

      // ‚úÖ BUG FIX: estava quebrado aqui
      const pagar = document.getElementById("vipPagar");
      pagar.href = checkoutUrl;
      pagar.onclick = () => { setButtonsDisabled(false); };

      document.getElementById("modalVip").style.display = "block";
    } catch {
      setButtonsDisabled(false);
      alert("Falha ao iniciar compra. Tente novamente.");
    }
  }

  async function copiarVip() {
    const txt = document.getElementById("vipTexto").textContent || "";
    try {
      await navigator.clipboard.writeText(txt);
      alert("Mensagem copiada ‚úÖ");
    } catch {
      alert("N√£o deu pra copiar automaticamente. Selecione e copie manualmente.");
    }
  }

  ensureLogin();
</script>


</body>
</html>
